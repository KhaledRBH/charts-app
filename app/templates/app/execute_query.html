{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  
  <meta charset="UTF-8">
  <title>Execute Query</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f9fafc;
      padding: 30px;
    }
    h2 {
      text-align: center;
      color: #333;
    }
    .container {
      max-width: 95%;
      margin: auto;
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    select, button, input[type="text"] {
      padding: 8px;
      font-size: 14px;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button {
      cursor: pointer;
      background: #007BFF;
      border: none;
      color: white;
      border-radius: 6px;
    }
    button:hover {
      background: #0056b3;
    }
    .error {
      color: red;
      margin-top: 10px;
    }

    .table-container {
      max-height: 70vh;
      overflow-y: auto;
      overflow-x: auto;
      border: 1px solid #ccc;
      margin-top: 20px;
    }

    table {
      width: 100%;
      min-width: max-content;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      white-space: nowrap;
    }
    th {
      background: #007BFF;
      color: white;
      position: relative;
    }
    tr:nth-child(even) {
      background: #f2f2f2;
    }

    /* Filter UI */
    .filter-btn {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 14px;
      margin-left: 6px;
    }
    .filter-menu {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      z-index: 100;
      max-height: 200px;
      overflow-y: auto;
      min-width: 180px;
      color: #333;
    }
    .filter-menu.active {
      display: block;
    }
    .filter-options label {
      display: flex;
      align-items: center;
      font-size: 13px;
      margin: 3px 0;
      cursor: pointer;
      color: #333;
    }
    .filter-options input {
      margin-right: 6px;
    }
    .filter-search {
      width: 100%;
      padding: 5px 6px;
      margin-bottom: 6px;
      font-size: 13px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .export-btns {
      margin-top: 15px;
      margin-bottom: 15px;
    }

    #export-csv-btn, #export-excel-btn {
      padding: 8px 16px;
      font-size: 14px;
      border-radius: 6px;
      cursor: pointer;
      border: none;
      color: white;
      margin-right: 10px;
    }

    #export-csv-btn {
      background: #28a745;
    }

    #export-excel-btn {
      background: #17a2b8;
    }

    #export-csv-btn:hover {
      background: #218838;
    }

    #export-excel-btn:hover {
      background: #138496;
    }

    #export-status {
      margin-left: 10px;
      color: #666;
      font-size: 14px;
      font-style: italic;
    }
  </style>
</head>

<body>

<h2>Execute Saved Queries</h2>
<form method="post" action="{% url 'logout' %}">
    {% csrf_token %}
    <button type="submit">Logout</button>
</form>
<div class="container">
  <div style="margin-bottom: 15px; text-align: right;">
    <a href="{% url 'add_query' %}">
      <button type="button">‚ûï Add Query</button>
    </a>
  </div>
  <form method="get" action="{% url 'execute_query' %}">
    <label>Select Query:</label>
    <select name="query_id">
      {% for q in queries %}
        <option value="{{ q.id }}" {% if q.id|stringformat:"s" == selected_id %}selected{% endif %}>
          {{ q.query_name|truncatechars:70 }}
        </option>
      {% endfor %}
    </select>

    <label>Add Condition:</label>
    <input type="text" name="condition" value="{{ condition }}"
           placeholder='e.g. AND a."name" LIKE ''ABC%'''>

    <button type="submit">Run Query</button>
    
  </form>

  {% if rows %}
    <div class="export-btns">
      <button type="button" id="export-csv-btn">Export to CSV</button>
      <button type="button" id="export-excel-btn">Export to Excel</button>
      <span id="export-status"></span>
    </div>
  {% endif %}

  {% if error %}
    <p class="error">‚ùå {{ error }}</p>
  {% endif %}

  {% if rows %}
  <div class="table-container">
    <table id="data-table">
      <thead>
        <tr>
          {% for col in columns %}
          <th>
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <span>{{ col }}</span>
              <button type="button" class="filter-btn" data-col="{{ forloop.counter0 }}">üîç</button>
              <div class="filter-menu" data-col="{{ forloop.counter0 }}">
                <div class="filter-options"></div>
              </div>
            </div>
          </th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
        <tr>
          {% for cell in row %}
            <td>{{ cell }}</td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    {% if selected_id %}
      <p>No data returned.</p>
    {% endif %}
  {% endif %}
</div>

<script>
  const QUERY_ID = "{{ selected_id }}";
  const CONDITION = "{{ condition|escapejs }}";
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const table = document.getElementById("data-table");
  if (!table) return;

  const tbody = table.querySelector("tbody");
  const container = document.querySelector(".table-container");

  // ---------------- CACHE ALL ROWS ----------------
  let allRows = Array.from(tbody.querySelectorAll("tr"));

  function syncRows() {
    allRows = Array.from(tbody.querySelectorAll("tr"));
  }

  // ---------------- GLOBAL VARIABLES FOR FILTERS ----------------
  const checkboxStates = [];
  let sortColumn = null;
  let sortDirection = 1;

  // ---------------- COLUMN FILTERS ----------------
  function initFilters() {
    const colCount = table.querySelectorAll("th").length;
    const valuesPerCol = Array.from({ length: colCount }, () => new Set());

    // Collect all unique values for each column
    allRows.forEach(row => {
      [...row.children].forEach((cell, i) => {
        valuesPerCol[i].add(cell.textContent.trim() || "(empty)");
      });
    });

    // Initialize checkboxStates for each column
    for (let i = 0; i < colCount; i++) {
      checkboxStates[i] = {};
      const values = [...valuesPerCol[i]].sort();
      values.forEach(val => {
        checkboxStates[i][val] = true;
      });
    }

    // Create filter UI for each column
    document.querySelectorAll(".filter-menu").forEach(menu => {
      const col = +menu.dataset.col;
      const opt = menu.querySelector(".filter-options");
      opt.innerHTML = "";

      // Search input
      const search = document.createElement("input");
      search.type = "text";
      search.placeholder = "Search...";
      search.className = "filter-search";
      opt.appendChild(search);

      const list = document.createElement("div");
      opt.appendChild(list);

      // Select All checkbox
      const selectAllLabel = document.createElement("label");
      const selectAllCb = document.createElement("input");
      selectAllCb.type = "checkbox";
      selectAllCb.checked = true;
      selectAllLabel.appendChild(selectAllCb);
      selectAllLabel.appendChild(document.createTextNode(" Select All"));
      list.appendChild(selectAllLabel);

      function renderCheckboxes(searchTerm = "") {
        list.innerHTML = "";
        list.appendChild(selectAllLabel);

        const allValues = Object.keys(checkboxStates[col]).sort();
        const filteredValues = allValues.filter(val => 
          val.toLowerCase().includes(searchTerm.toLowerCase())
        );

        filteredValues.forEach(val => {
          const label = document.createElement("label");
          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.checked = checkboxStates[col][val];
          cb.value = val;
          label.append(cb, document.createTextNode(" " + val));
          list.appendChild(label);

          cb.addEventListener("change", () => {
            checkboxStates[col][val] = cb.checked;
            updateSelectAllState();
            applyFilter();
          });
        });

        updateSelectAllState();
      }

      function updateSelectAllState() {
        const allValues = Object.keys(checkboxStates[col]);
        const allChecked = allValues.every(val => checkboxStates[col][val]);
        selectAllCb.checked = allChecked;
      }

      selectAllCb.addEventListener("change", () => {
        const allValues = Object.keys(checkboxStates[col]);
        allValues.forEach(val => {
          checkboxStates[col][val] = selectAllCb.checked;
        });
        renderCheckboxes(search.value);
        applyFilter();
      });

      search.addEventListener("input", (e) => {
        renderCheckboxes(e.target.value);
      });

      renderCheckboxes();
    });
  }

  // ---------------- APPLY FILTER ----------------
  function applyFilter() {
    const rules = [];

    checkboxStates.forEach((states, colIndex) => {
      if (!states) return;
      
      const checkedValues = Object.entries(states)
        .filter(([val, checked]) => checked)
        .map(([val]) => val);
      rules[colIndex] = checkedValues.length ? checkedValues : null;
    });

    allRows.forEach(row => {
      const visible = [...row.children].every((cell, i) => {
        const value = cell.textContent.trim() || "(empty)";
        return rules[i] === null || rules[i].includes(value);
      });
      row.style.display = visible ? "" : "none";
    });
    
    // Update export status
    updateExportStatus();
  }

  // ---------------- GET FILTERED DATA ----------------
  function getFilteredData() {
    const data = [];
    
    // Get column headers
    const headers = Array.from(table.querySelectorAll("th")).map(th => 
      th.querySelector("span").textContent.trim()
    );
    data.push(headers);
    
    // Get filtered rows
    allRows.forEach(row => {
      if (row.style.display !== "none") {
        const rowData = Array.from(row.querySelectorAll("td")).map(td => 
          td.textContent.trim()
        );
        data.push(rowData);
      }
    });
    
    return data;
  }

  // ---------------- EXPORT TO CSV ----------------
  function exportToCSV() {
    const data = getFilteredData();
    const csvContent = data.map(row => 
      row.map(cell => {
        // Escape quotes and wrap in quotes if contains comma, quote, or newline
        if (/[",\n]/.test(cell)) {
          return `"${cell.replace(/"/g, '""')}"`;
        }
        return cell;
      }).join(',')
    ).join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", `query_${QUERY_ID}_export_${new Date().toISOString().slice(0,10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    document.getElementById("export-status").textContent = `Exported ${data.length - 1} rows to CSV`;
    document.getElementById("export-status").style.color = "#28a745";
  }

  // ---------------- EXPORT TO EXCEL ----------------
  function exportToExcel() {
    // Alternative: Export as CSV with .xls extension (opens in Excel)
    const data = getFilteredData();
    const csvContent = data.map(row => 
      row.map(cell => {
        if (/[",\n\t]/.test(cell)) {
          return `"${cell.replace(/"/g, '""')}"`;
        }
        return cell;
      }).join('\t')
    ).join('\n');
    
    // Add UTF-8 BOM for Excel compatibility
    const BOM = "\uFEFF";
    const blob = new Blob([BOM + csvContent], { type: 'application/vnd.ms-excel;charset=utf-8' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", `query_${QUERY_ID}_export_${new Date().toISOString().slice(0,10)}.xls`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    document.getElementById("export-status").textContent = `Exported ${data.length - 1} rows to Excel`;
    document.getElementById("export-status").style.color = "#17a2b8";
  }

  // ---------------- UPDATE EXPORT STATUS ----------------
  function updateExportStatus() {
    const visibleRows = allRows.filter(row => row.style.display !== "none").length;
    const statusEl = document.getElementById("export-status");
    if (statusEl) {
      if (visibleRows === allRows.length) {
        statusEl.textContent = `${visibleRows} rows (all visible)`;
      } else {
        statusEl.textContent = `${visibleRows} rows (filtered from ${allRows.length})`;
      }
      statusEl.style.color = visibleRows < allRows.length ? "#ff9800" : "#28a745";
    }
  }

  // ---------------- ADD SORTING FUNCTIONALITY ----------------
  function addSorting() {
    const headers = table.querySelectorAll("th");
    headers.forEach((header, index) => {
      const span = header.querySelector("span");
      header.style.cursor = "pointer";
      header.title = "Click to sort";
      
      header.addEventListener("click", () => {
        // Update sort indicators
        headers.forEach(h => {
          const hSpan = h.querySelector("span");
          hSpan.textContent = hSpan.textContent.replace(/ [‚Üë‚Üì]$/, '');
        });
        
        if (sortColumn === index) {
          sortDirection = -sortDirection;
        } else {
          sortColumn = index;
          sortDirection = 1;
        }
        
        span.textContent = span.textContent + (sortDirection === 1 ? ' ‚Üë' : ' ‚Üì');
        sortTable(index);
      });
    });
  }

  function sortTable(columnIndex) {
    const rows = Array.from(tbody.querySelectorAll("tr"));
    
    rows.sort((a, b) => {
      const aVal = a.children[columnIndex].textContent.trim();
      const bVal = b.children[columnIndex].textContent.trim();
      
      // Try numeric comparison
      const aNum = parseFloat(aVal.replace(/[^0-9.-]/g, ''));
      const bNum = parseFloat(bVal.replace(/[^0-9.-]/g, ''));
      
      if (!isNaN(aNum) && !isNaN(bNum)) {
        return (aNum - bNum) * sortDirection;
      }
      
      // String comparison
      return aVal.localeCompare(bVal) * sortDirection;
    });
    
    // Reorder in DOM
    const fragment = document.createDocumentFragment();
    rows.forEach(row => fragment.appendChild(row));
    tbody.appendChild(fragment);
    syncRows();
  }

  // ---------------- FILTER MENU TOGGLE ----------------
  document.querySelectorAll(".filter-btn").forEach(btn => {
    btn.addEventListener("click", e => {
      e.stopPropagation();
      document.querySelectorAll(".filter-menu").forEach(m => m.classList.remove("active"));
      btn.nextElementSibling.classList.toggle("active");
    });
  });

  document.addEventListener("click", (e) => {
    document.querySelectorAll(".filter-menu").forEach(menu => {
      const filterBtn = menu.previousElementSibling;
      if (!menu.contains(e.target) && !filterBtn.contains(e.target)) {
        menu.classList.remove("active");
      }
    });
  });

  // ---------------- EXPORT BUTTON LISTENERS ----------------
  const exportCsvBtn = document.getElementById("export-csv-btn");
  const exportExcelBtn = document.getElementById("export-excel-btn");
  
  if (exportCsvBtn) {
    exportCsvBtn.addEventListener("click", exportToCSV);
  }
  
  if (exportExcelBtn) {
    exportExcelBtn.addEventListener("click", exportToExcel);
  }

  // ---------------- INITIALIZE ----------------
  initFilters();
  addSorting();
  updateExportStatus();

  // ---------------- INFINITE SCROLL ----------------
  let offset = allRows.length;
  const limit = 200;
  let loading = false;

  async function loadMore() {
    if (loading || !QUERY_ID) return;
    loading = true;

    try {
      const res = await fetch(
        `{% url 'load_more_query_rows' %}?query_id=${QUERY_ID}&condition=${encodeURIComponent(CONDITION)}&offset=${offset}&limit=${limit}`
      );
      const data = await res.json();

      if (data.rows && data.rows.length) {
        data.rows.forEach(r => {
          const tr = document.createElement("tr");
          r.forEach(c => {
            const td = document.createElement("td");
            td.textContent = c ?? "";
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });

        syncRows();
        initFilters();
        applyFilter();
        updateExportStatus();
        offset += data.rows.length;
      }
    } catch (err) {
      console.error(err);
    }
    loading = false;
  }

  if (container) {
    container.addEventListener("scroll", () => {
      if (container.scrollTop + container.clientHeight >= container.scrollHeight - 150) {
        loadMore();
      }
    });
  }
});
</script>

</body>
</html>